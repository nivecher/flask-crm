{% extends "base.html" %}
{% from "_formhelpers.html" import render_field %}

{% block content %}
    <h1>{{ title }}</h1>
    <form action="" method="post" novalidate>
        {{ form.hidden_tag() }}
        {{ render_field(form.name) }}
        {{ render_field(form.email) }}
        {{ render_field(form.phone) }}
        <div class="form-group">
            {{ form.address.label(class="form-control-label") }}
            {{ form.address(class="form-control") }}
            <span id="address-valid-indicator"></span>
            <div id="address-suggestions"></div>
        </div>
        {{ form.submit(class="btn btn-primary") }}
    </form>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const addressInput = document.getElementById('address');
        const suggestionsDiv = document.getElementById('address-suggestions');
        const validIndicator = document.getElementById('address-valid-indicator');
        const phoneInput = document.getElementById('phone');
        let addressIsValid = false;

        addressInput.addEventListener('input', function() {
            const query = addressInput.value;
            addressIsValid = false;
            validIndicator.innerHTML = '<span style="color: orange;">&#9888;</span>'; // Warning icon

            if (query.length < 3) {
                suggestionsDiv.innerHTML = '';
                if (query.length === 0) {
                    validIndicator.innerHTML = '';
                }
                return;
            }
            fetch(`/api/address-autocomplete?query=${query}`)
                .then(response => response.json())
                .then(data => {
                    let suggestionsHTML = '<ul class="list-group">';
                    data.forEach(prediction => {
                        suggestionsHTML += `<li class="list-group-item list-group-item-action" data-description="${prediction.description}">${prediction.description}</li>`;
                    });
                    suggestionsHTML += '</ul>';
                    suggestionsDiv.innerHTML = suggestionsHTML;
                });
        });

        suggestionsDiv.addEventListener('click', function(e) {
            if (e.target && e.target.matches('li.list-group-item-action')) {
                addressInput.value = e.target.dataset.description;
                suggestionsDiv.innerHTML = '';
                validIndicator.innerHTML = '<span style="color: green;">&#10004;</span>'; // Checkmark
                addressIsValid = true;
            }
        });

        phoneInput.addEventListener('input', function(e) {
            let x = e.target.value.replace(/\D/g, '').match(/(\d{0,3})(\d{0,3})(\d{0,4})/);
            e.target.value = !x[2] ? x[1] : '(' + x[1] + ') ' + x[2] + (x[3] ? '-' + x[3] : '');
        });

        const form = document.querySelector('form');
        form.addEventListener('submit', function(e) {
            if (!addressIsValid && addressInput.value.length > 0) {
                e.preventDefault();
                alert('Please select a valid address from the suggestions.');
                validIndicator.innerHTML = '<span style="color: red;">&#10008;</span>'; // X mark
            }
        });
    });
</script>
{% endblock %}
